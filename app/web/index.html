<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Klug Media</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f6f8fb;
        --fg: #152238;
        --panel: #ffffff;
        --border: #d7deea;
        --accent: #1f6feb;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
        background: linear-gradient(160deg, #edf3ff, #f6f8fb 35%, #f9fcff);
        color: var(--fg);
      }
      .wrap {
        max-width: 980px;
        margin: 0 auto;
        padding: 20px;
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
      }
      h1,
      h2 {
        margin: 0 0 12px;
      }
      form,
      .row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      input,
      button {
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
      }
      input {
        min-width: 250px;
      }
      button {
        background: var(--accent);
        border-color: var(--accent);
        color: #fff;
        cursor: pointer;
      }
      button.secondary {
        background: #fff;
        color: var(--fg);
      }
      ul {
        margin: 0;
        padding-left: 18px;
      }
      .muted {
        color: #4f607e;
      }
      .hidden {
        display: none;
      }
      .error {
        color: #b42318;
      }
      @media (max-width: 680px) {
        input {
          min-width: 100%;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Klug Media</h1>
        <p class="muted">Session-based frontend smoke page</p>
        <div id="auth-status" class="muted">Checking session...</div>
      </div>

      <div id="login-card" class="card hidden">
        <h2>Login</h2>
        <form id="login-form">
          <input id="password" type="password" placeholder="Session password" required />
          <button type="submit">Login</button>
        </form>
        <p id="login-error" class="error"></p>
      </div>

      <div id="app-card" class="card hidden">
        <div class="row">
          <button id="refresh-shows">Refresh Shows</button>
          <button id="logout-btn" class="secondary">Logout</button>
        </div>
        <h2>Shows</h2>
        <ul id="show-list"></ul>
      </div>

      <div id="detail-card" class="card hidden">
        <h2 id="detail-title">Show Detail</h2>
        <p id="detail-progress" class="muted"></p>
        <ul id="episode-list"></ul>
      </div>
    </div>

    <script>
      const authStatus = document.getElementById("auth-status");
      const loginCard = document.getElementById("login-card");
      const appCard = document.getElementById("app-card");
      const detailCard = document.getElementById("detail-card");
      const loginForm = document.getElementById("login-form");
      const loginError = document.getElementById("login-error");
      const showList = document.getElementById("show-list");
      const refreshShows = document.getElementById("refresh-shows");
      const logoutBtn = document.getElementById("logout-btn");
      const detailTitle = document.getElementById("detail-title");
      const detailProgress = document.getElementById("detail-progress");
      const episodeList = document.getElementById("episode-list");

      async function api(path, options = {}) {
        const response = await fetch(path, {
          credentials: "include",
          headers: { "Content-Type": "application/json", ...(options.headers || {}) },
          ...options,
        });
        return response;
      }

      function setAuthenticatedUI(authenticated, message) {
        authStatus.textContent = message;
        loginCard.classList.toggle("hidden", authenticated);
        appCard.classList.toggle("hidden", !authenticated);
      }

      async function checkSession() {
        const response = await api("/api/v1/session/me");
        const payload = await response.json();
        if (payload.authenticated) {
          setAuthenticatedUI(true, "Authenticated");
          await loadShows();
        } else {
          setAuthenticatedUI(false, "Not authenticated");
        }
      }

      async function loadShows() {
        showList.innerHTML = "";
        const response = await api("/api/v1/shows");
        if (!response.ok) {
          authStatus.textContent = "Failed to load shows";
          return;
        }
        const shows = await response.json();
        if (shows.length === 0) {
          showList.innerHTML = "<li class='muted'>No shows found</li>";
          return;
        }
        for (const show of shows) {
          const li = document.createElement("li");
          const button = document.createElement("button");
          button.className = "secondary";
          button.textContent = `${show.title} (${show.year || "n/a"})`;
          button.onclick = () => loadShowDetail(show.show_id);
          li.appendChild(button);
          showList.appendChild(li);
        }
      }

      async function loadShowDetail(showId) {
        const response = await api(`/api/v1/shows/${showId}`);
        if (!response.ok) {
          return;
        }
        const detail = await response.json();
        detailCard.classList.remove("hidden");
        detailTitle.textContent = detail.show.title;
        const progress = detail.progress[0];
        detailProgress.textContent = progress
          ? `Progress: ${progress.watched_episodes}/${progress.total_episodes} (${progress.watched_percent}%)`
          : "Progress: no watched data yet";

        episodeList.innerHTML = "";
        for (const ep of detail.episodes) {
          const li = document.createElement("li");
          const watchedLabel =
            ep.watched_by_user === null
              ? `watches: ${ep.watched_count}`
              : ep.watched_by_user
                ? "watched"
                : "not watched";
          li.textContent = `S${ep.season_number ?? "?"}E${ep.episode_number ?? "?"} - ${ep.title} (${watchedLabel})`;
          episodeList.appendChild(li);
        }
      }

      loginForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        loginError.textContent = "";
        const password = document.getElementById("password").value;
        const response = await api("/api/v1/session/login", {
          method: "POST",
          body: JSON.stringify({ password }),
        });
        if (!response.ok) {
          loginError.textContent = "Login failed";
          return;
        }
        await checkSession();
      });

      refreshShows.addEventListener("click", async () => {
        await loadShows();
      });

      logoutBtn.addEventListener("click", async () => {
        await api("/api/v1/session/logout", { method: "DELETE" });
        detailCard.classList.add("hidden");
        await checkSession();
      });

      checkSession();
    </script>
  </body>
</html>
